# AI Coders Are Among Us: Rethinking Programming Language Grammar Towards Efficient Code Generation

- International Symposium on Software Testing and Analysis 2024

- [paper](https://dl.acm.org/doi/pdf/10.1145/3650212.3680347)

- ChatGPT 4o

- [ ] 人工修正

## 动机

传统编程语言的语法设计主要服务于人类开发者的可读性需求。然而，随着大型语言模型（LLMs）在代码生成和任务执行中的重要性不断增加，当前基于人类可读性的语法设计对这些模型的效率产生了显著影响，导致计算资源的浪费和推理效率降低。因此，本文提出了一个以AI为中心的语法设计概念，旨在通过减少冗余的语法标记优化代码生成效率，从而降低LLMs的计算成本，改善其性能。

## 创新点

1. 我们提出了AI导向语法的概念，并通过实证研究探索其可行性和潜力，为未来优先考虑AI效率的编程语言设计改进铺平道路。
2. 我们实现了首个面向AI的Python语法，命名为SimPy，它可以至少减少Python源代码中的8.3%令牌数量。
3. 我们提出了一种新颖的代码生成框架DualCode，将AI导向语法的适用性扩展到超越仅限AI的场景，同时几乎不会增加额外的延迟。

## 与现有方法的区别

- **优化方向**：现有方法主要聚焦于代码简化（Program Simplification），通过去除人类可读性相关的冗余标记提高模型的处理效率。然而，这些方法通常不可逆，限制了代码的进一步生成或转换。本文提出的以AI为中心的语法设计（AI-oriented Grammar），如SimPy，从语法规则的根本层面优化代码表示，不仅减少了不必要的标记，还保持了代码的语义一致性和可逆性。
- **处理方式**：现有方法依赖于模型生成后对代码的后处理，例如根据注意力权重移除低权重标记。本文的方法通过语法设计减少初始代码中的冗余符号（如冒号、换行符），使代码生成效率更高，并能与现有编译器无缝对接。
- **适用场景**：现有方法通常应用于代码理解任务（如摘要和检索），无法直接服务于代码生成场景。本文的DualCode框架支持模型在生成AI优化语法代码后通过转换器无缝生成人类可读代码，扩展了AI优化语法的适用范围。
- **效率提升**：相比于仅优化标记的现有方法，本文在减少标记数量的同时，通过构造轻量级的转换器，实现了更低的推理计算开销，并在一定条件下提升了代码生成任务的准确性。

## 详细方法

1. **提出以AI为中心的语法设计概念**
   - 观察到现有编程语言语法主要服务于人类的可读性需求，而这对AI模型的推理效率造成了额外的计算负担。论文提出以AI为中心的语法设计（AI-oriented Grammar）概念，旨在通过减少冗余标记和优化代码语法，使代码更适合AI模型处理，同时保持代码语义不变。

2. **设计SimPy语法作为AI导向语法的证明概念**
   - 基于Python语法，通过移除或替换冗余的分隔符（如冒号、括号）、空白字符和换行符等，设计SimPy语法。
   - 确保SimPy语法与Python共享相同的抽象语法树（AST），以保证语义等价性。
   - 使用简单的启发式规则设计SimPy语法，包括：
     - 替换终端符号（例如，将“def”替换为“<def_stmt>”）。
     - 合并分隔符（例如，将“NEWLINE INDENT”替换为“<block_start>”）。
     - 删除冗余符号（例如，移除函数定义中的冒号和括号）。

3. **开发SimPy的解析器和转换工具**
   - 使用Tree-sitter工具生成基于SimPy语法的解析器，确保没有语法歧义。
   - 构建SimPy与Python之间的双向转换工具，通过AST节点级规则实现无损转换。
   - 对转换器进行验证，包括文本比对测试和运行测试（如将Python代码转换为SimPy，再转换回Python，验证语义不变）。


## 研究问题

1. **RQ1：AI导向语法在源代码中的标记压缩能力是多少？**  
   - 探讨AI导向语法是否能显著减少代码中的标记数量，以及减少的幅度有多大。

2. **RQ2：AI模型如何理解AI导向语法？**  
   - 研究AI模型能否通过训练准确地学习和应用AI导向语法，并评估不同训练策略对模型性能的影响。

3. **RQ3：AI导向语法如何支持实际场景？**  
   - 探讨AI导向语法在真实世界中的应用场景，尤其是在需要人类与AI协作的情境下，如何通过框架设计（如DualCode）平衡效率和可读性。

### 评价指标

1. **标记数量减少率（Token Reduction Rate）**  
   - 用于评估AI导向语法（如SimPy）相较于原始语法（如Python）在代码表示中减少的标记数量百分比。  

2. **代码生成任务的准确性（Pass@k）**  
   - **Pass@1**：在生成的代码样本中，是否有至少1个样本能够通过所有单元测试。  
   - **Pass@10**：在生成的10个代码样本中，是否有至少1个样本通过所有单元测试。  
   - 该指标用于评估模型在代码生成任务中的性能，测试基于HumanEval数据集。

3. **转换器的处理延迟（Latency）**  
   - 测量DualCode框架中的输入和输出转换器将代码从Python转换为SimPy（或反之）的平均处理时间。  
   - 按代码长度分为不同区间（如0-100个标记、100-500个标记等）进行延迟测试，以评估转换器的效率。

4. **模型训练效率**  
   - 比较模型在不同训练策略（如直接用SimPy训练和Python→SimPy微调）下的训练收敛速度和性能表现。

通过这些指标，论文系统性地评估了AI导向语法的有效性、模型学习能力、实际应用的可行性和效率。

### 每个研究问题的结果

**RQ1：AI导向语法在源代码中的标记压缩能力是多少？**

- 实验方法：
1. **设计SimPy语法**：
   - 修改Python语法，移除冗余分隔符（如冒号和括号）和空白符号（如换行和缩进）。
   - 确保SimPy与Python的抽象语法树（AST）完全一致，保持代码语义不变。

2. **数据准备**：
   - 使用从开源GitHub仓库中筛选出的Python代码数据集，包含62万余个代码文件。
   - 将Python代码转换为SimPy代码，创建SimPy数据集。

3. **标记器选择**：
   - 使用14种LLM标记器（如GPT-4、CodeLlama等），分别对Python和SimPy代码进行标记化处理。
   - 比较标记数量，评估标记压缩能力。

- 实验结果：
  - SimPy语法在所有标记器上均减少了标记数量，具体压缩率范围为**8.6%-34.7%**。
  - **GPT-4**和**GPT-3.5**的标记数量减少了**10.4%**，即使在效率较高的标记器上也有显著改进。
  - 对标记效率较低的标记器（如CodeBERT和GPT-2），压缩率高达**34.7%**。

**RQ2：AI模型如何理解AI导向语法？**

- 实验方法：
1. **模型与训练策略**：  
   - 使用三个模型：CodeGen-NL、TinyLlama和Pythia（参数规模350M至1.1B）。  
   - 比较三种训练策略：  
     - **Python**：仅用Python数据集训练。  
     - **SimPy**：仅用SimPy数据集训练。  
     - **Python→SimPy**：先用Python数据集训练，再用SimPy数据集进行微调，比例分别为10%、20%、50%和100%。  

2. **评估方法**：  
   - 使用HumanEval数据集测试模型在代码生成任务中的性能，计算**Pass@1**和**Pass@10**指标。  
   - HumanEval测试生成代码是否能通过给定的单元测试。  

- 实验结果：
  - **SimPy策略**：
     - 仅用SimPy数据集训练的模型在性能上低于Python基线模型。
     - 例如，CodeGen (SimPy) 的**Pass@10**为5.49%，低于CodeGen (Python) 的7.32%。
  - **Python→SimPy策略**：  
     - 微调SimPy数据集后的模型性能超越了Python基线模型。  
     - 例如，CodeGen在100% SimPy微调后，**Pass@10**提升至9.15%，优于Python的7.32%。
     - TinyLlama (Python→100%SimPy) 达到了**Pass@10 14.02%**，比Python训练的基线模型（13.41%）更高。  

**RQ3：AI导向语法如何支持实际场景？**

- 实验方法：  
1. **基本场景**：  
   - AI导向语法适用于仅需AI生成和执行代码的场景，如AI代理任务（例如自动生成并执行爬虫脚本）。  
   - 模型生成的SimPy代码可直接执行，或转换回Python代码后执行。  

2. **扩展场景（DualCode框架）**：  
   - 提出DualCode框架，使用输入和输出转换器在AI语法与人类语法之间进行双向转换。  
   - 输入转换器将人类编写的Python代码转为SimPy语法，输出转换器将AI生成的SimPy代码转为Python语法。  

3. **转换器性能测试**：  
   - 按代码长度分组，测量转换器将Python代码转为SimPy和反向转换的平均处理时间。  
   - 将转换器的性能与Huggingface的标记器进行对比。  

- 实验结果：  
  - **基本场景**：SimPy代码可高效执行，无需额外转换，适用于无人工参与的代码生成任务。  
  - **转换器性能**：  
     - 对于小于500个标记的代码，转换时间为**0.2-1.0ms**，与Huggingface标记器的性能相当。  
     - 对于5000个标记以上的代码，转换时间保持在**几十毫秒**内，延迟极低。  

## 有效性威胁

1. **模型规模限制**：  
   - 实验主要在参数规模约为1B的小型模型上进行，未验证在更大规模模型（如GPT-4级别）上的效果。
   - 尽管方法在小型模型中验证了AI导向语法的效率改进，但模型规模扩大的情况下可能存在未考虑的性能影响。

2. **编程语言范围局限**：  
   - 实验仅在Python语言中测试，而未覆盖其他编程语言（如Java、C++）。  
   - 结果可能无法推广至语法结构更复杂或符号使用频率不同的语言。

3. **转换器效率低下**：  
   - 转换器是用Python实现的，效率不如更底层的高效语言（如C++）。  
   - 当前实现可能低估了转换器的实际性能潜力，影响了实验结果的精确性。

## 未来展望

1. **进一步研究AI导向语法的潜力**  
   - 探索AI导向语法如何显著提升代码生成任务中AI模型的准确性，强调语法设计对模型理解代码语义的关键作用。  

2. **设计更适合AI模型的语法**  
   - 研究如何构建本质上对AI模型更易理解的语法，从而提升AI模型的性能。  

3. **开发自动化语法优化方法**  
   - 探讨通过自动化方法优化语法的可能性，例如利用解析器生成器迭代搜索可以被移除的语法标记或结构，以简化语法。  

4. **降低模型学习新语法的成本**  
   - 开发更高效的训练方法，使得大型语言模型能够以更低的成本学习新的AI导向语法，减少数据需求和训练时间。  

5. **推动社区参与和研究**  
   - 呼吁软件工程社区进一步投入该领域的研究，深入探讨AI导向语法的优化和应用潜力，推动其在AI编程中的广泛使用。  
